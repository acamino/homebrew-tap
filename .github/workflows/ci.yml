name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  audit:
    name: Audit Formula
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Audit formula (strict)
        run: brew audit --strict --online acamino/tap/table-extractor

  test-macos-arm64:
    name: Test on macOS ARM64
    runs-on: macos-latest
    needs: audit
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install formula (timed)
        run: |
          START=$(date +%s)
          brew install acamino/tap/table-extractor
          END=$(date +%s)
          DURATION=$((END - START))
          echo "Installation took $DURATION seconds"

          # Installation should be fast (< 10 seconds) with pre-built binary
          # If it takes longer, it might be compiling from source
          if [ $DURATION -gt 15 ]; then
            echo "Installation took longer than expected. Might be compiling from source?"
            echo "Expected: < 10 seconds (binary), Got: $DURATION seconds"
            exit 1
          fi

          echo "Fast binary installation confirmed"

      - name: Verify installation
        run: |
          tabx --version
          echo "Checking for pre-built binary install..."
          brew list --verbose acamino/tap/table-extractor | grep -q "bin/tabx"
          echo "Installation verified"

      - name: Test basic functionality
        run: |
          echo "Creating test CSV file..."
          echo "id,name" > test.csv
          echo "1,Alice" >> test.csv
          echo "2,Bob" >> test.csv

          echo "Converting CSV to TSV..."
          OUTPUT=$(tabx test.csv)
          echo "Output received:"
          echo "$OUTPUT"

          if ! echo "$OUTPUT" | grep -q "Alice"; then
            echo "ERROR: Expected 'Alice' in output but not found"
            echo "Full output was:"
            echo "$OUTPUT"
            exit 1
          fi

          echo "CSV to TSV conversion works"

      - name: Test completions installed
        run: |
          echo "Checking for shell completions..."

          ZSH_COMPLETION="/opt/homebrew/share/zsh/site-functions/_tabx"
          BASH_COMPLETION="/opt/homebrew/etc/bash_completion.d/tabx"

          if [[ ! -f "$ZSH_COMPLETION" ]]; then
            echo "ERROR: Zsh completion not found at $ZSH_COMPLETION"
            echo "Files in directory:"
            ls -la /opt/homebrew/share/zsh/site-functions/ || echo "Directory does not exist"
            exit 1
          fi

          if [[ ! -f "$BASH_COMPLETION" ]]; then
            echo "ERROR: Bash completion not found at $BASH_COMPLETION"
            echo "Files in directory:"
            ls -la /opt/homebrew/etc/bash_completion.d/ || echo "Directory does not exist"
            exit 1
          fi

          echo "Shell completions installed"

      - name: Run formula tests
        run: |
          brew test acamino/tap/table-extractor
          echo "Formula tests passed"

  test-macos-x86_64:
    name: Test on macOS x86_64
    runs-on: macos-13  # Intel Mac
    needs: audit
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install formula (timed)
        run: |
          START=$(date +%s)
          brew install acamino/tap/table-extractor
          END=$(date +%s)
          DURATION=$((END - START))
          echo "Installation took $DURATION seconds"

      - name: Verify installation
        run: |
          tabx --version
          echo "Checking for pre-built binary install..."
          brew list --verbose acamino/tap/table-extractor | grep -q "bin/tabx"
          echo "Installation verified"

      - name: Test basic functionality
        run: |
          echo "Creating test CSV file..."
          echo "id,name" > test.csv
          echo "1,Alice" >> test.csv
          echo "2,Bob" >> test.csv

          echo "Converting CSV to TSV..."
          OUTPUT=$(tabx test.csv)
          echo "Output received:"
          echo "$OUTPUT"

          if ! echo "$OUTPUT" | grep -q "Alice"; then
            echo "ERROR: Expected 'Alice' in output but not found"
            echo "Full output was:"
            echo "$OUTPUT"
            exit 1
          fi

          echo "CSV to TSV conversion works"

      - name: Test completions installed
        run: |
          echo "Checking for shell completions..."

          ZSH_COMPLETION="/usr/local/share/zsh/site-functions/_tabx"
          BASH_COMPLETION="/usr/local/etc/bash_completion.d/tabx"

          if [[ ! -f "$ZSH_COMPLETION" ]]; then
            echo "ERROR: Zsh completion not found at $ZSH_COMPLETION"
            echo "Files in directory:"
            ls -la /usr/local/share/zsh/site-functions/ || echo "Directory does not exist"
            exit 1
          fi

          if [[ ! -f "$BASH_COMPLETION" ]]; then
            echo "ERROR: Bash completion not found at $BASH_COMPLETION"
            echo "Files in directory:"
            ls -la /usr/local/etc/bash_completion.d/ || echo "Directory does not exist"
            exit 1
          fi

          echo "Shell completions installed"

      - name: Run formula tests
        run: |
          brew test acamino/tap/table-extractor
          echo "Formula tests passed"

  test-linux:
    name: Test on Linux x86_64
    runs-on: ubuntu-latest
    needs: audit
    steps:
      - uses: actions/checkout@v4

      - name: Set up Homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install formula (timed)
        run: |
          START=$(date +%s)
          brew install acamino/tap/table-extractor
          END=$(date +%s)
          DURATION=$((END - START))
          echo "Installation took $DURATION seconds"

      - name: Verify installation
        run: |
          tabx --version
          echo "Checking for pre-built binary install..."
          brew list --verbose acamino/tap/table-extractor | grep -q "bin/tabx"
          echo "Installation verified"

      - name: Test basic functionality
        run: |
          echo "Creating test CSV file..."
          echo "id,name" > test.csv
          echo "1,Alice" >> test.csv
          echo "2,Bob" >> test.csv

          echo "Converting CSV to TSV..."
          OUTPUT=$(tabx test.csv)
          echo "Output received:"
          echo "$OUTPUT"

          if ! echo "$OUTPUT" | grep -q "Alice"; then
            echo "ERROR: Expected 'Alice' in output but not found"
            echo "Full output was:"
            echo "$OUTPUT"
            exit 1
          fi

          echo "CSV to TSV conversion works"

      - name: Test completions installed
        run: |
          echo "Checking for shell completions..."
          BREW_PREFIX=$(brew --prefix)

          ZSH_COMPLETION="$BREW_PREFIX/share/zsh/site-functions/_tabx"
          BASH_COMPLETION="$BREW_PREFIX/etc/bash_completion.d/tabx"

          if [[ ! -f "$ZSH_COMPLETION" ]]; then
            echo "ERROR: Zsh completion not found at $ZSH_COMPLETION"
            echo "Files in directory:"
            ls -la "$BREW_PREFIX/share/zsh/site-functions/" || echo "Directory does not exist"
            exit 1
          fi

          if [[ ! -f "$BASH_COMPLETION" ]]; then
            echo "ERROR: Bash completion not found at $BASH_COMPLETION"
            echo "Files in directory:"
            ls -la "$BREW_PREFIX/etc/bash_completion.d/" || echo "Directory does not exist"
            exit 1
          fi

          echo "Shell completions installed"

      - name: Run formula tests
        run: |
          brew test acamino/tap/table-extractor
          echo "Formula tests passed"

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [audit, test-macos-arm64, test-macos-x86_64, test-linux]
    steps:
      - name: Mark CI as successful
        run: echo "All CI checks passed!"
